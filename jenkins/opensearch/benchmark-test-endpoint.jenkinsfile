/*
 * Copyright OpenSearch Contributors
 * SPDX-License-Identifier: Apache-2.0
 *
 * The OpenSearch Contributors require contributions made to
 * this file be licensed under the Apache-2.0 license or a
 * compatible open source license.
 */

lib = library(identifier: 'jenkins@10.3.0', retriever: modernSCM([

    $class: 'GitSCMSource',
    remote: 'https://github.com/opensearch-project/opensearch-build-libraries.git',
]))

pipeline {
    agent none
    options {
        timeout(time: 24, unit: 'HOURS')
        buildDiscarder(logRotator(daysToKeepStr: '30'))
    }
    environment {
        AGENT_LABEL = 'Jenkins-Agent-AL2023-X64-M52xlarge-Benchmark-Test'
        JOB_NAME = 'benchmark-test'
    }
    parameters {
            password(
                name: 'CLUSTER_ENDPOINT',
                description: 'Provide an endpoint to a cluster for running benchmark tests against it.',
            )
            booleanParam(
                name: 'SECURITY_ENABLED',
                description: 'Mention if the cluster is secured or insecured.',
                defaultValue: false,
            )
            password(
                name: 'USERNAME',
                description: 'Enter username for the cluster endpoint',
                defaultValue: ''
            )
            password(
                name: 'PASSWORD',
                description: 'Enter password for the cluster endpoint',
                defaultValue: ''
            )
            booleanParam(
                name: 'SIGV4',
                description: 'Mention if the test will run using AWS Signature Version 4 authentication.',
                defaultValue: false,
            )
            string(
                name: 'REGION',
                description: 'AWS region for signing (e.g. us-east-1).',
                defaultValue: 'us-east-1',
                trim: true
            )
            choice(
                name: 'SERVICE',
                choices: ['','es', 'aoss'],
                description: 'AWS service for SigV4'
            )
            string(
                name: 'TEST_WORKLOAD',
                description: 'The workload name from OpenSearch Benchmark Workloads.',
                defaultValue: 'nyc_taxis',
                trim: true
            )
            string(
                name: 'USER_TAGS',
                description: 'Attach arbitrary text to the meta-data of each benchmark metric record, without any spaces. e.g., `run-type:adhoc,segrep:enabled,arch:x64`. ',
                trim: true
            )
            string(
                name: 'WORKLOAD_PARAMS',
                description: 'With this parameter you can inject variables into workloads. Use json type. e.g., `{"number_of_replicas":"1","number_of_shards":"5"}`',
                trim: true
            )
            string(
                name: 'TEST_PROCEDURE',
                description: 'Defines a test procedure to use. e.g., `append-no-conflicts,significant-text`',
                trim: true
            )
            string(
                name: 'EXCLUDE_TASKS',
                description: 'Defines a comma-separated list of test procedure tasks not to run. Default runs all. e.g., `type:search,delete-index`',
                trim: true
            )
            string(
                name: 'INCLUDE_TASKS',
                description: 'Defines a comma-separated list of test procedure tasks to run. Default runs all. e.g., `type:search,delete-index`',
                trim: true
            )
            booleanParam(
                name: 'CAPTURE_NODE_STAT',
                description: 'Enable opensearch-benchmark node-stats telemetry to capture system level metrics.',
                defaultValue: false
            )
            booleanParam(
                name: 'CAPTURE_SEGMENT_REPLICATION_STAT',
                description: 'Enable opensearch-benchmark segment-replication-stats telemetry to capture metrics such as replication lag.',
                defaultValue: false
            )
            string(
                name: 'TELEMETRY_PARAMS',
                description: 'Allows to set parameters for telemetry devices. Use json type. e.g.,{"node-stats-include-indices":"true","node-stats-include-indices-metrics":"segments"}',
                trim: true
            )
    }

    triggers{
        parameterizedCron '''
            H 10 * * * %CLUSTER_ENDPOINT=vpc-aos-2-19-big5-cczkhj6jqnqncozqwweqt6true.us-east-1.es.amazonaws.com;SECURITY_ENABLED=true;SIGV4=true;REGION=us-east-1;SERVICE=es;TEST_WORKLOAD=big5;USER_TAGS=run-type:nightly,arch:x64,instance-type:c5.2xlarge,service:aos,cluster-config:x64-c5.2xlarge-single-node-1-shards-0-replica-aos-219,version-ident:aos-219;INCLUDE_TASKS=type:search;CAPTURE_NODE_STAT=true
            H 10 * * * %CLUSTER_ENDPOINT=vpc-aos-2-17-big5-lmjc6dl2lct537wgud56l4uexm.us-east-1.es.amazonaws.com;SECURITY_ENABLED=true;SIGV4=true;REGION=us-east-1;SERVICE=es;TEST_WORKLOAD=big5;USER_TAGS=run-type:nightly,arch:x64,instance-type:c5.2xlarge,service:aos,cluster-config:x64-c5.2xlarge-single-node-1-shards-0-replica-aos-217,version-ident:aos-217;INCLUDE_TASKS=type:search;CAPTURE_NODE_STAT=true
            H 10 * * * %CLUSTER_ENDPOINT=vpc-aos-3-1-big5-x2bogl4h7iq2uaqeomwpz6he7i.us-east-1.es.amazonaws.com;SECURITY_ENABLED=true;SIGV4=true;REGION=us-east-1;SERVICE=es;TEST_WORKLOAD=big5;USER_TAGS=run-type:nightly,arch:x64,instance-type:c5.2xlarge,service:aos,cluster-config:x64-c5.2xlarge-single-node-1-shards-0-replica-aos-310,version-ident:aos-310;INCLUDE_TASKS=type:search;CAPTURE_NODE_STAT=true
            H 10 * * * %CLUSTER_ENDPOINT=g6h917k6rrc2hxkis97g.us-east-1.aoss.amazonaws.com;SECURITY_ENABLED=true;SIGV4=true;REGION=us-east-1;SERVICE=aoss;TEST_WORKLOAD=big5;USER_TAGS=run-type:nightly,arch:x64,instance-type:c5.2xlarge,service:aoss,cluster-config:x64-c5.2xlarge-single-node-1-shards-0-replica-aoss-217,version-ident:aoss-217;INCLUDE_TASKS=type:search

            H 11 * * * %CLUSTER_ENDPOINT=vpc-aos-2-19-big5-css-nvzz5gho5owpndu35guuyaohym.us-east-1.es.amazonaws.com;SECURITY_ENABLED=true;SIGV4=true;REGION=us-east-1;SERVICE=es;TEST_WORKLOAD=big5;USER_TAGS=run-type:nightly,arch:x64,instance-type:c5.2xlarge,service:aos,cluster-config:x64-c5.2xlarge-single-node-1-shards-0-replica-aos-css-219,version-ident:aos-219;INCLUDE_TASKS=type:search;CAPTURE_NODE_STAT=true
            H 11 * * * %CLUSTER_ENDPOINT=vpc-aos-2-17-big5-css-db5dpfhkxvnj5goj7mj2gvaj3q.us-east-1.es.amazonaws.com;SECURITY_ENABLED=true;SIGV4=true;REGION=us-east-1;SERVICE=es;TEST_WORKLOAD=big5;USER_TAGS=run-type:nightly,arch:x64,instance-type:c5.2xlarge,service:aos,cluster-config:x64-c5.2xlarge-single-node-1-shards-0-replica-aos-css-217,version-ident:aos-217;INCLUDE_TASKS=type:search;CAPTURE_NODE_STAT=true

            H 11 * * * %CLUSTER_ENDPOINT=guiorotvn7cqjfic9i7k.us-east-1.aoss.amazonaws.com;SECURITY_ENABLED=true;SIGV4=true;REGION=us-east-1;SERVICE=aoss;TEST_WORKLOAD=vectorsearch;USER_TAGS=run-type:nightly,arch:arm64,instance-type:r7g.2xlarge,service:aoss,cluster-config:arm64-r7g.2xlarge-3-shards-1-replica-faiss-cohere-1m-aoss-217,version-ident:aoss-217;WORKLOAD_PARAMS={"target_index_name":"target_index","target_field_name":"target_field","target_index_body":"indices/faiss-index.json","target_index_dimension":768,"target_index_space_type":"innerproduct","id_field_name":"id","target_index_bulk_size":100,"target_index_bulk_index_data_set_format":"hdf5","target_index_bulk_index_data_set_corpus":"cohere-1m","target_index_bulk_indexing_clients":10,"hnsw_ef_search":256,"hnsw_ef_construction":256,"query_k":100,"query_body":{"docvalue_fields":["id"],"stored_fields":"_none_"},"query_data_set_format":"hdf5","query_data_set_corpus":"cohere-1m","query_count":10000};TEST_PROCEDURE=no-train-test-aoss
            H 11 * * * %CLUSTER_ENDPOINT=vpc-aos-3-1-faiss-1m-vector-qey635pv7fov2hkw2k6ivbz6ja.us-east-1.es.amazonaws.com;SECURITY_ENABLED=true;SIGV4=true;REGION=us-east-1;SERVICE=es;TEST_WORKLOAD=vectorsearch;USER_TAGS=run-type:nightly,arch:arm64,instance-type:r7g.2xlarge,service:aos,cluster-config:arm64-r7g.2xlarge-3-shards-1-replica-faiss-cohere-1m-aos-310,version-ident:aos-310;WORKLOAD_PARAMS={"target_index_name":"target_index","target_field_name":"target_field","target_index_body":"indices/faiss-index.json","target_index_primary_shards":3,"target_index_dimension":768,"target_index_space_type":"innerproduct","target_index_bulk_size":100,"target_index_bulk_index_data_set_format":"hdf5","target_index_bulk_index_data_set_corpus":"cohere-1m","target_index_bulk_indexing_clients":10,"target_index_max_num_segments":1,"hnsw_ef_search":256,"hnsw_ef_construction":256,"query_k":100,"query_body":{"docvalue_fields":["_id"],"stored_fields":"_none_"},"query_data_set_format":"hdf5","query_data_set_corpus":"cohere-1m","query_count":10000};CAPTURE_NODE_STAT=true
            H 11 * * * %CLUSTER_ENDPOINT=vpc-aos-2-17-faiss-1m-vector-6fxmlcrgzhia3tkbklvwaqwr5u.us-east-1.es.amazonaws.com;SECURITY_ENABLED=true;SIGV4=true;REGION=us-east-1;SERVICE=es;TEST_WORKLOAD=vectorsearch;USER_TAGS=run-type:nightly,arch:arm64,instance-type:r7g.2xlarge,service:aos,cluster-config:arm64-r7g.2xlarge-3-shards-1-replica-faiss-cohere-1m-aos-217,version-ident:aos-217;WORKLOAD_PARAMS={"target_index_name":"target_index","target_field_name":"target_field","target_index_body":"indices/faiss-index.json","target_index_primary_shards":3,"target_index_dimension":768,"target_index_space_type":"innerproduct","target_index_bulk_size":100,"target_index_bulk_index_data_set_format":"hdf5","target_index_bulk_index_data_set_corpus":"cohere-1m","target_index_bulk_indexing_clients":10,"target_index_max_num_segments":1,"hnsw_ef_search":256,"hnsw_ef_construction":256,"query_k":100,"query_body":{"docvalue_fields":["_id"],"stored_fields":"_none_"},"query_data_set_format":"hdf5","query_data_set_corpus":"cohere-1m","query_count":10000};CAPTURE_NODE_STAT=true
            H 11 * * * %CLUSTER_ENDPOINT=opense-clust-MJ7liAQ2UQS6-c8f9a43a694ce2db.elb.us-east-1.amazonaws.com;SECURITY_ENABLED=false;SIGV4=false;REGION=us-east-1;TEST_WORKLOAD=vectorsearch;USER_TAGS=run-type:nightly,arch:arm64,instance-type:r7g.2xlarge,service:os,cluster-config:arm64-r7g.2xlarge-3-shards-1-replica-faiss-cohere-1m-os-310,version-ident:os-310;WORKLOAD_PARAMS={"target_index_name":"target_index","target_field_name":"target_field","target_index_body":"indices/faiss-index.json","target_index_primary_shards":3,"target_index_dimension":768,"target_index_space_type":"innerproduct","target_index_bulk_size":100,"target_index_bulk_index_data_set_format":"hdf5","target_index_bulk_index_data_set_corpus":"cohere-1m","target_index_bulk_indexing_clients":10,"target_index_max_num_segments":1,"hnsw_ef_search":256,"hnsw_ef_construction":256,"query_k":100,"query_body":{"docvalue_fields":["_id"],"stored_fields":"_none_"},"query_data_set_format":"hdf5","query_data_set_corpus":"cohere-1m","query_count":10000};CAPTURE_NODE_STAT=true
            H 11 * * * %CLUSTER_ENDPOINT=opense-clust-U1DZkBwaI7Ad-c38d6016b749ffa5.elb.us-east-1.amazonaws.com;SECURITY_ENABLED=false;SIGV4=false;REGION=us-east-1;TEST_WORKLOAD=vectorsearch;USER_TAGS=run-type:nightly,arch:arm64,instance-type:r7g.2xlarge,service:os,cluster-config:arm64-r7g.2xlarge-3-shards-1-replica-faiss-cohere-1m-os-217,version-ident:os-217;WORKLOAD_PARAMS={"target_index_name":"target_index","target_field_name":"target_field","target_index_body":"indices/faiss-index.json","target_index_primary_shards":3,"target_index_dimension":768,"target_index_space_type":"innerproduct","target_index_bulk_size":100,"target_index_bulk_index_data_set_format":"hdf5","target_index_bulk_index_data_set_corpus":"cohere-1m","target_index_bulk_indexing_clients":10,"target_index_max_num_segments":1,"hnsw_ef_search":256,"hnsw_ef_construction":256,"query_k":100,"query_body":{"docvalue_fields":["_id"],"stored_fields":"_none_"},"query_data_set_format":"hdf5","query_data_set_corpus":"cohere-1m","query_count":10000};CAPTURE_NODE_STAT=true

            H 12 * * * %CLUSTER_ENDPOINT=opense-clust-h9z3ly7hHkqp-724c4a4910d3a9f0.elb.us-east-1.amazonaws.com;SECURITY_ENABLED=false;TEST_WORKLOAD=big5;USER_TAGS=run-type:nightly,arch:x64,instance-type:c5.2xlarge,service:os,cluster-config:x64-c5.2xlarge-single-node-1-shards-0-replica-os-efs-332,version-ident:os-332;INCLUDE_TASKS=type:search
            H 12 * * * %CLUSTER_ENDPOINT=3a8ie5yu2t9vv620kpme.gamma-us-east-1.aoss.amazonaws.com;SECURITY_ENABLED=true;SIGV4=true;REGION=us-east-1;SERVICE=aoss;TEST_WORKLOAD=big5;USER_TAGS=run-type:nightly,arch:arm64,instance-type:c6gd.large,service:aoss,cluster-config:arm64-c6gd.large-default-shards-aoss-2x-3x,version-ident:aoss-2x-3x;INCLUDE_TASKS=type:search
        '''
    }

    stages {
        stage('validate-and-set-parameters') {
            agent { label AGENT_LABEL }
            steps {
                script {
                    if (CLUSTER_ENDPOINT == '') {
                        currentBuild.result = 'ABORTED'
                        error("Benchmark Tests failed to start. Provide CLUSTER_ENDPOINT to run tests")
                    }
                }
            }
            post {
                always {
                    postCleanup()
                }
            }
        }
        stage('benchmark-test-with-cluster') {
            agent { label AGENT_LABEL }
            steps {
                script {
                    echo "security-enabled: ${SECURITY_ENABLED}"

                    runBenchmarkTestScript(
                        command: 'execute-test',
                        endpoint: CLUSTER_ENDPOINT,
                        insecure: !(params.SECURITY_ENABLED),
                        username: USERNAME,
                        password: PASSWORD,
                        sigv4: SIGV4,
                        region: REGION,
                        service: SERVICE,
                        workload: TEST_WORKLOAD,
                        userTag: USER_TAGS.isEmpty() ? "security-enabled:${SECURITY_ENABLED}" : "${USER_TAGS},security-enabled:${SECURITY_ENABLED}",
                        suffix: "${BUILD_NUMBER}",
                        workloadParams: WORKLOAD_PARAMS,
                        testProcedure: TEST_PROCEDURE,
                        excludeTasks: EXCLUDE_TASKS,
                        includeTasks: INCLUDE_TASKS,
                        captureNodeStat: CAPTURE_NODE_STAT,
                        captureSegmentReplicationStat: CAPTURE_SEGMENT_REPLICATION_STAT,
                        telemetryParams: TELEMETRY_PARAMS
                    )
                    stash includes: 'test_execution*.csv', name: "benchmark"

                }
            }
            post {
                always {
                    unstash "benchmark"
                    archiveArtifacts artifacts: 'test_execution*.csv'
                    postCleanup()
                }
            }
        }
    }
}
