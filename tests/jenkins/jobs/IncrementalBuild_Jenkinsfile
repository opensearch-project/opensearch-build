pipeline {
    agent none
    stages {
        stage('build and assemble, sha exists') {
            steps {
                script {
                    buildAssembleUpload(
                        dryRun: false, // will check whether SHA exists, which is stubbed to return true
                        manifest: 'tests/jenkins/data/opensearch-1.3.0.yml',
                        platform: 'linux',
                        architecture: 'x64'
                    )
                }
            }
        }
        stage('build and assemble, sha does not exist') {
            steps {
                script {
                    buildAssembleUpload(
                        dryRun: true, // will skip checking whether SHA exists or not
                        manifest: 'tests/jenkins/data/opensearch-1.3.0.yml',
                        platform: 'linux',
                        architecture: 'x64'
                    )
                }
            }
        }
        stage('builds docker image') {
            steps {
                script {
                    env.ARTIFACT_URL_linux_x64 = 'opensearch.linux.x64'
                    env.ARTIFACT_URL_linux_arm64 = 'opensearch.linux.arm64'
                    buildDockerImage(
                        manifest: 'tests/jenkins/data/opensearch-1.3.0.yml'
                    )
                }
            }
        }
        stage('skips docker because x64 is missing') {
            steps {
                script {
                    env.ARTIFACT_URL_linux_x64 = null
                    env.ARTIFACT_URL_linux_arm64 = 'opensearch.linux.arm64'
                    buildDockerImage(
                        manifest: 'tests/jenkins/data/opensearch-1.3.0.yml'
                    )
                }
            }
        }
        stage('skips docker because arm64 is missing') {
            steps {
                script {
                    env.ARTIFACT_URL_linux_x64 = 'opensearch.linux.x64'
                    env.ARTIFACT_URL_linux_arm64 = null
                    buildDockerImage(
                        manifest: 'tests/jenkins/data/opensearch-1.3.0.yml'
                    )
                }
            }
        }
        stage('skips docker because both x64 and arm64 are missing') {
            steps {
                script {
                    env.ARTIFACT_URL_linux_x64 = null
                    env.ARTIFACT_URL_linux_arm64 = null
                    buildDockerImage(
                        manifest: 'tests/jenkins/data/opensearch-1.3.0.yml'
                    )
                }
            }
        }
    }
}
