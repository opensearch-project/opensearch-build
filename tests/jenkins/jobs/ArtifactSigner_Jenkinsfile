pipeline {
    agent none
    stages {
        stage('sign') {
            steps {
                script {
                    if (ARTIFACT_PATH == '') {
                        currentBuild.result = 'ABORTED'
                        error('ARTIFACT_PATH is not set')
                    }
                    ARTIFACT_PATH = ARTIFACT_PATH.replaceAll('/$', "")
                    set_up()
                    argsMap = [:]
                    argsMap['artifactPath'] = "$WORKSPACE/artifacts/${ARTIFACT_PATH}"
                    argsMap['signatureType'] = "${SIGNATURE_TYPE}"
                    argsMap['distributionPlatform'] = "${DISTRIBUTION_PLATFORM}"
                    signArtifacts(argsMap)
                    upload_artifacts()
                }
            }
        }
    }
}

void upload_artifacts(){
    // Upload signature files to S3
    withAWS(role: "${ARTIFACT_UPLOAD_ROLE_NAME}", roleAccount: "${AWS_ACCOUNT_PUBLIC}", duration: 900, roleSessionName:
            'jenkins-session') {
        // upload signature files to S3
        s3Upload(file: "$WORKSPACE/artifacts/${ARTIFACT_PATH}", bucket: "${ARTIFACT_BUCKET_NAME}", path: "${ARTIFACT_PATH}/signed")
    }
}

void set_up() {
    git url: 'https://github.com/opensearch-project/opensearch-build.git', branch: 'main'

    withAWS(role: "${ARTIFACT_DOWNLOAD_ROLE_NAME}", roleAccount: "${AWS_ACCOUNT_PUBLIC}", duration: 900, roleSessionName: 'jenkins-session') {
        s3Download(file: "$WORKSPACE/artifacts/", bucket: "${ARTIFACT_BUCKET_NAME}", path: "${ARTIFACT_PATH}/", force: true)
    }
}
