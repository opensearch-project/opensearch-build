#!/bin/bash
###### Information ############################################################################
# Name:          wss-scan.sh
# Language:      Shell
#
# About:         This script is to scan the OpenSearch distros for vulnerabilities and licenses
#                It will scan the repositories and send the WhiteSource link to the mail 
#                of the user. 
#
# Prerequisites: Need to install Java 11
#                Export JAVA_HOME env variable to the JDK path
#                Add JAVA_HOME to PATH variable
#                Need to set the recepient mail in wss-scan.config for local run
#                WhiteSource API key is needed for local run, The API Key can be retrieved from the
#                WhiteSource Admin Console of your account.Use the below command to export the API key
#                export wss_apikey=$(APIKEY)
#
# Usage:         ./wss-scan.sh
#
###############################################################################################

set -e

java -version
if [ "$?" != 0 ]
then 
  echo "Java has not been setup" 
  exit 1
fi

if [ ! -f "wss-unified-agent.jar" ]
then
  # Download the WhiteSource Agent 
  wget -q https://github.com/whitesource/unified-agent-distribution/releases/latest/download/wss-unified-agent.jar
  # The version 21.10.2 has been tested and can be used if a specific version is required
  #wget -q  https://github.com/whitesource/unified-agent-distribution/releases/download/v21.10.2/wss-unified-agent.jar
fi

# scan the config file for the user configurations
# wss-scan.config has to be present in the same working directory as the script
source wss-scan.config

# change comma to whitespace
gitRepos=${gitRepos//,/$'\n'} 

basepath=$baseDirPath"/repos"

echo "Cleaning up scan directories if already present"
rm -rf $basepath

mkdir -p $basepath
 
# clone the desired Repos for scanning 
for repo in $gitRepos
do
  echo "Cloning repo "$gitBasePath$repo
  git clone "$gitBasePath$repo".git $basepath"/"$repo
done

echo -n > info.txt

# scan the Repos using the WhiteSource Unified Agent
for repo in $gitRepos
do
  repo_path=$basepath"/"$repo
  if [ -d "$repo_path" ]
  then
    echo "Scanning repo: "$gitBasePath$repo " Project: " $repo
    java -jar wss-unified-agent.jar -c wss-unified-agent.config -d $repo_path -apiKey $wss_apikey -product "My Product" -project $repo > ${repo}.log
  else
    echo "Scanning failed for repo: "$gitBasePath$repo " Project: " $repo
  fi
done

# remove the WhiteSource unified Jar 
rm "wss-unified-agent.jar" 
echo "WhiteSource vulnerability scan done"
